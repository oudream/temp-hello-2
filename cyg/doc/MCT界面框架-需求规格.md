# CT 界面框架 · 需求规格（草案 v3 完整版）

> 目标：提供一个模块化、可拓展、面向工业 CT 的通用界面外壳。核心是**页（Page）**与**面板（Panel）**解耦，**URibbon**负责“功能块→功能名”的两层操作承载；3D-Page 内置四视图（2×2、1&3），采用**外部滚动条+小按钮**的一体式交互。

---

## 1. 术语与对象
- **页（Page）**：占据中央工作区的一级功能页面。当前必须有：**项目、原图、重建、3D页、试检**。
- **面板（Panel）**：右侧 Dock 的功能侧栏，支持显示/隐藏/浮动。当前包含：**属性、渲染、日志**。
- **URibbon**：位于窗口上方，两层结构：
    - **功能块**（上层）：对应 Page 维度的大类入口（项目/原图/重建/3D/试检/通用…）。
    - **功能名**（下层）：选中功能块后显示的分组操作按钮。
- **四视图**：3D-Page 内的 Axial/Sagittal/Coronal/3D 四窗容器，支持 2×2 / 1&3 两种布局，以及“等分”。

---

## 2. 顶层布局与导航
- 窗口顶部：**URibbon** 两层（功能块→功能名）。
- 中央：**Stacked Pages**（默认进入 3D 页）。
- 右侧：**Dock 面板区**（属性/渲染/日志），通过 UPanelManager 统一注册、显隐与浮动。

---

## 3. URibbon 结构（功能块 → 功能名）

### 3.1 功能块（上层）
- **项目**
- **原图**
- **重建**
- **体编**
- **体选**
- **切面**
- **渲染**
- **测量**
- **分割**
- **配准**
- **窗体**
- **转换**
- **试检**

说明：共有5页【项目、原图、重建、3D页、试验】。
说明：点这些功能块，中央都切换到对应页（体编~转换 → 切到 3D 页）。

### 3.2 功能名（下层，按分组显示）
- **项目**
    - 新建、打开、保存、另存、最近项目、模板管理、工程参数、备份/恢复
- **原图**
    - 导入（DICOM/RAW/TIFF/序列）、批量管理、元数据、预处理（去条纹、归一化）、视图预设
- **重建**
    - 扫描参数、几何标定、算法选择（FDK/ART/SART/迭代…）、GPU/CPU、执行/暂停/继续、日志/进度、结果集
- **3D页： 体编 / 体选 / 切面 / 渲染 / 测量 / 分割 / 配准 / 窗体 / 转换**
    - 每个功能块进入 3D 页，URibbon 下层功能名分组不同，例如：
        - 体编：体素编辑工具、撤销/重做、合并/分裂
        - 体选：体素选择工具、多边形选择、魔棒选择
        - 切面：MPR 三刀操作、旋转、移动
        - 渲染：体渲染/MIP/表面、光照、LUT
        - 测量：直线、角度、圆、面积
        - 分割：阈值、区域生长、AI 分割
        - 配准：刚性、非刚性、点云对齐
        - 窗体：布局：2×2、1&3、等分（下拉点选，单个）；面板（显示/隐藏）：显示/隐藏属性、渲染、日志（下拉勾选，多个）
        - 转换：数据导出、格式转换
- **试检**
    - 判定策略（阈值/模板/AI）、ROI/掩膜、批量处理、统计/报表、导出

### 3.3 代码设计：使用注册登记模式，功能块与功能名都描述好，做好路由与状态管理

---

## 4. 页面（Pages）与职责
- **项目页**：工程级信息总览（路径、批次、模板、最近记录、配置导入导出）
- **原图页**：影像资产浏览与管理（文件树/缩略图、批量导入、元数据、基础预处理）
- **重建页**：重建流程控制台（参数、几何、算法、执行/暂停/恢复、进度、结果版本管理）
- **3D页**：内置**FourViewWidget**，提供四窗布局与交互；主窗通过 `fourView()` 获取实例以接收 URibbon 的布局指令
- **试检页**：规则/阈值/AI 的检测流程、批量任务/统计/报表

---

## 5. 面板（Panels）与职责
- **属性**：显示当前对象/视图的属性（窗宽窗位、反相、单位、刻度…）
- **渲染**：模式（体渲染/MIP/表面）、不透明度/传递函数、LUT、光照、采样率等
- **日志**：系统与任务日志（级别过滤、搜索、导出）

---

## 6. 3D页-四视图与交互
- **布局模式**：2×2、1&3
- **等分**：窗口尺寸变化或手动触发时自动等分
- **外部滚动条 + 小按钮**：
    - 右侧竖条旁：+、-、适应
    - 底部横条旁：缩小、放大、合适
- **滚动条联动**：每个视图要外部滚动条 + 小按钮（+、-、适应 / 缩小、放大、合适），不要内部滚动条
- **缩放/适配（视图级）**：按钮直连 `zoomIn/zoomOut/fitToView`
- **联动开关（预留）**：后续支持多视图同步缩放/平移/十字线

---

## 7. 主要交互流（示例）
1. 启动 → 默认进入 **3D 页**
2. 点击 URibbon 功能块：
    - 项目/原图/重建/试检 → 切换到对应 Page
    - 体编/体选/切面/渲染/测量/分割/配准/窗体/转换 → 切换到 3D 页，并加载对应功能名分组
3. 使用 URibbon 下层按钮进行布局、面板控制
4. 在四视图小窗内用外部滚动条和按钮缩放/平移/适配

---

## 8. 验收清单（第一阶段）
- [ ] 页：项目/原图/重建/3D/试检 可切换
- [ ] 面板：属性/渲染/日志 可显隐/浮动
- [ ] URibbon：两层结构，功能块→功能名
- [ ] 四视图：2×2/1&3 切换，等分有效，外部滚动条+按钮可用
- [ ] 启动默认进入 3D 页

---

## 9. 快捷键
- `Ctrl+1/2/3/4/5`：切换到 项目/原图/重建/3D/试检 页
- `Ctrl+G`：2×2 布局
- `Ctrl+J`：1&3 布局
- `Ctrl+E`：等分
- 视图内：`Ctrl+滚轮` 缩放；`Space+拖拽` 平移；`F` 适配

---

## 10. 配置与持久化（第三阶段）
- 最近项目列表
- 最后一次打开的页
- 四视图布局模式
- 各面板可见性
- 日志级别
- 渲染预设
- **存储方式**：`QSettings`（组织/应用名已在主程序设置）

---

## 11. 国际化与主题（第二阶段）
- 所有可见文案均使用 `tr()` 包装
- 默认加载深色 QSS（可切换/覆盖）

---

## 12. 非功能性要求
- **解耦**：Page 独立、Panel 独立、URibbon 只发信号，主窗做路由
- **性能**：四视图支持延迟渲染/局部刷新；面板 Dock 浮动不阻断渲染线程
- **一致性**：缩放/平移快捷键统一；UI 元素统一风格
- **可测试性**：面板注册、布局切换、页面切换均可单元测试

---
